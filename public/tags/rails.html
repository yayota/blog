<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="chrome=1" />
  <meta name="viewport" content="width=device-width, minimum-scale=1.0" />
  <link rel="stylesheet" href="/css/style-db97c835f88a11034a9bb34f063ff69a.css" type="text/css" />
  <link rel="alternate" type="application/atom+xml" href="https://tomafro.net/atom.xml" />
  <link rel="canonical" href="https://tomafro.net/tags/rails"/>
  <script type="text/javascript" src="//use.typekit.com/brv6igt.js"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  <title>Posts tagged with rails &middot; tomafro.net</title>
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1103395-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script');
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
          'http://www') + '.google-analytics.com/ga.js';
      ga.setAttribute('async', 'true');
      document.documentElement.firstChild.appendChild(ga);
    })();
  </script>
  <!--[if lt IE 9]>
  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>
<body>
  <nav>
  <ul>
    <li><a href='/'>tomafro.net</a><span class='byline'> &ndash; a blog by Tom Ward</span></li>
    <li><a href='/about'>about</a></li>
    <li><a href='https://github.com/tomafro'>github</a></li>
    <li><a href='https://twitter.com/tomafro'>twitter</a></li>
  </ul>
</nav>
  <article>
  <header>
    <h1><a href="/2011/08/presenting-the-hashblue-api">Presenting the #blue api</a></h1>
  </header>
  <div class="content">
    <p>In building <a href="https://hashblue.com">#blue</a> (sign up now!), one of the problems we faced was how to build <code>json</code> data in response to requests to <a href="https://api.hashblue.com">our API</a>.  The typical rails solution would be to override <code>#as_json</code> in a model class, then write a controller like this:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">ContactsController</span> <span class="o">&lt;</span> <span class="no">ApiController</span>
  <span class="n">responds_to</span> <span class="ss">:json</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">respond_with</span> <span class="no">Contact</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>I always prefer to keep my controllers as skinny as possible, so this looks like a great solution.  The <code>respond_with</code> call takes care of converting the message to json and responding with the right <code>Content-Type</code>, all in a simple call.  However it has a number of problems and disadvantages.</p>

<p>The biggest issue for our API is that rather than expose the <code>id</code> of each model, we&rsquo;ve tried to encourage the use of the <code>uri</code> instead.  So the <code>json</code> returned for a single contact (for example) looks like this:</p>

<div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;contact&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;uri&quot;</span><span class="o">:</span> <span class="s2">&quot;https://api.example.com/contacts/ccpwjc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;George&quot;</span><span class="p">,</span>
    <span class="s2">&quot;email&quot;</span><span class="o">:</span> <span class="s2">&quot;george@handmade.org&quot;</span><span class="p">,</span>
    <span class="s2">&quot;msisdn&quot;</span><span class="o">:</span> <span class="s2">&quot;447897897899&quot;</span><span class="p">,</span>
    <span class="s2">&quot;phone_number&quot;</span><span class="o">:</span> <span class="s2">&quot;07897897899&quot;</span><span class="p">,</span>
    <span class="s2">&quot;messages&quot;</span><span class="o">:</span> <span class="s2">&quot;https://api.example.com/contacts/ccpwjc/messages&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
</div>


<p>It doesn&rsquo;t just have a <code>uri</code> for the actual contact, but also for the messages belonging to that contact (and yes, I regret not calling that attribute <code>messages_uri</code>).  Models can&rsquo;t generate uris, and shouldn&rsquo;t really be aware of them, so overriding <code>#as_json</code> doesn&rsquo;t work.  In any case, the json structure is really presentation logic, not business logic.  It doesn&rsquo;t belong in the model.</p>

<h3>Presenting a single model</h3>

<p>The solution we&rsquo;ve used is to build a presenter for each model, solely responsible for building the json.  Here&rsquo;s an example for a contact:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">ContactPresenter</span>
  <span class="kp">include</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">url_helpers</span>

  <span class="kp">attr_accessor</span> <span class="ss">:controller</span><span class="p">,</span> <span class="ss">:subject</span>
  <span class="n">delegate</span> <span class="ss">:params</span><span class="p">,</span> <span class="ss">:url_options</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="ss">:controller</span>
  <span class="n">delegate</span> <span class="ss">:errors</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="ss">:subject</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
    <span class="vi">@controller</span> <span class="o">=</span> <span class="n">controller</span>
    <span class="vi">@subject</span> <span class="o">=</span> <span class="n">subject</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="p">{</span><span class="ss">:contact</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="ss">:uri</span> <span class="o">=&gt;</span> <span class="n">uri</span><span class="p">,</span>
      <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">subject</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
      <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">subject</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
      <span class="ss">:msisdn</span> <span class="o">=&gt;</span> <span class="n">subject</span><span class="o">.</span><span class="n">msisdn</span><span class="p">,</span>
      <span class="ss">:phone_number</span> <span class="o">=&gt;</span> <span class="n">subject</span><span class="o">.</span><span class="n">phone_number</span><span class="p">,</span>
      <span class="ss">:messages</span> <span class="o">=&gt;</span> <span class="n">api_contact_messages_url</span><span class="p">(</span><span class="ss">:contact_id</span> <span class="o">=&gt;</span> <span class="n">subject</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">uri</span>
    <span class="n">api_contact_url</span><span class="p">(</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">subject</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>It&rsquo;s now simple to rewrite our controller to use the new presenter:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">ContactsController</span> <span class="o">&lt;</span> <span class="no">ApiController</span>
  <span class="n">responds_to</span> <span class="ss">:json</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">respond_with</span> <span class="no">ContactPresenter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="no">Contact</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<h3>Presenting pages of models</h3>

<p>The presenter above works well for a single model, but many of our API calls return a page of results.  The <a href="https://api.hashblue.com/doc/GET%3Acontacts">/contacts</a> for example returns all the contacts belonging to a user (of which there may be hundreds).  Luckily it&rsquo;s simple to adapt this pattern to present pages like this.  First, we change our original <code>#as_json</code> method slightly:</p>

<div class="highlight"><pre><span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
  <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:partial</span><span class="o">]</span>
    <span class="p">{</span>
      <span class="ss">:uri</span> <span class="o">=&gt;</span> <span class="n">uri</span><span class="p">,</span>
      <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">subject</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
      <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">subject</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
      <span class="ss">:msisdn</span> <span class="o">=&gt;</span> <span class="n">subject</span><span class="o">.</span><span class="n">msisdn</span><span class="p">,</span>
      <span class="ss">:phone_number</span> <span class="o">=&gt;</span> <span class="n">subject</span><span class="o">.</span><span class="n">phone_number</span><span class="p">,</span>
      <span class="ss">:messages</span> <span class="o">=&gt;</span> <span class="n">api_contact_messages_url</span><span class="p">(</span><span class="ss">:contact_id</span> <span class="o">=&gt;</span> <span class="n">subject</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span><span class="ss">:contact</span> <span class="o">=&gt;</span> <span class="n">as_json</span><span class="p">(</span><span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>This change allows us to call as_json with the options <code>:partial</code>.  With the option, a hash of data is returned.  Without, the same hash is returned, wrapped in another hash.</p>

<p>Next, add a page presenter:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">ContactPagePresenter</span>
  <span class="kp">include</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">url_helpers</span>

  <span class="kp">attr_accessor</span> <span class="ss">:controller</span><span class="p">,</span> <span class="ss">:subject</span>
  <span class="n">delegate</span> <span class="ss">:params</span><span class="p">,</span> <span class="ss">:url_options</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="ss">:controller</span>
  <span class="n">delegate</span> <span class="ss">:errors</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="ss">:subject</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
    <span class="vi">@controller</span> <span class="o">=</span> <span class="n">controller</span>
    <span class="vi">@subject</span> <span class="o">=</span> <span class="n">subject</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">contacts</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">o</span><span class="o">|</span> <span class="no">ContactPresenter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span><span class="o">.</span><span class="n">as_json</span><span class="p">(</span><span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>

    <span class="p">{</span><span class="ss">:contacts</span> <span class="o">=&gt;</span> <span class="n">contacts</span><span class="p">}</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">result</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">subject</span><span class="o">.</span><span class="n">previous_page</span>
        <span class="n">result</span><span class="o">[</span><span class="ss">:previous_page_uri</span><span class="o">]</span> <span class="o">=</span> <span class="n">contacts_url</span><span class="p">(</span><span class="n">subject</span><span class="o">.</span><span class="n">previous_page</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">subject</span><span class="o">.</span><span class="n">next_page</span>
        <span class="n">result</span><span class="o">[</span><span class="ss">:next_page_uri</span><span class="o">]</span> <span class="o">=</span> <span class="n">contacts_url</span><span class="p">(</span><span class="n">subject</span><span class="o">.</span><span class="n">next_page</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>Finally, we can add an index action using this presenter:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">ContactsController</span> <span class="o">&lt;</span> <span class="no">ApiController</span>
  <span class="n">responds_to</span> <span class="ss">:json</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">respond_with</span> <span class="no">ContactPagePresenter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="no">Contact</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span>
      <span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">,</span> 
      <span class="ss">:per_page</span> <span class="o">=&gt;</span> <span class="mi">50</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<h3>Refactoring common logic</h3>

<p>The code above is a very much simplified version of what we do in <a href="https://hashblue.com">#blue</a>.  We have many controllers, and several different models, so in our actual code we&rsquo;ve abstracted out as much common logic as possible.  In reality, our contacts controller looks more like this:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">ContactsController</span> <span class="o">&lt;</span> <span class="no">ApiController</span>
  <span class="n">before_filter</span> <span class="ss">:find_contact</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">present</span> <span class="vi">@contact</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">present_page_of</span> <span class="n">current_account</span><span class="o">.</span><span class="n">contacts</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@contact</span> <span class="o">=</span> <span class="n">current_account</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
    <span class="vi">@contact</span><span class="o">.</span><span class="n">save</span>
    <span class="n">present</span> <span class="vi">@contact</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@contact</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
    <span class="n">present</span> <span class="vi">@contact</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">find_contact</span>
    <span class="vi">@contact</span> <span class="o">=</span> <span class="n">current_account</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:_id</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="n">head</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="ss">:not_found</span> <span class="k">unless</span> <span class="vi">@contact</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>I think the code looks pretty clean.  The clever stuff happens in the <code>#present</code> and <code>#present_page_of</code> methods, defined in the superclass:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">ApiController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">present</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">presenter</span> <span class="o">=</span> <span class="n">presenter_class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
    <span class="n">options</span><span class="o">[</span><span class="ss">:location</span><span class="o">]</span> <span class="o">||=</span> <span class="n">presenter</span><span class="o">.</span><span class="n">uri</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">post?</span> <span class="o">&amp;&amp;</span> <span class="n">subject</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">respond_with</span> <span class="n">presenter</span><span class="p">,</span> <span class="n">options</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">present_page_of</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">presenter</span> <span class="o">=</span> <span class="n">page_presenter_class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">page_of</span><span class="p">(</span><span class="n">collection</span><span class="p">))</span>
    <span class="n">respond_with</span> <span class="n">presenter</span><span class="p">,</span> <span class="n">options</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">page_of</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
    <span class="n">collection</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:per_page</span> <span class="o">=&gt;</span> <span class="mi">50</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">presenter_class</span>
    <span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="s2">&quot;Controller&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">singularize</span> <span class="o">+</span> <span class="s2">&quot;Presenter&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">constantize</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">page_presenter_class</span>
    <span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="s2">&quot;Controller&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">singularize</span> <span class="o">+</span> <span class="s2">&quot;PagePresenter&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">constantize</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>The <code>#present</code> and <code>#present_page_of</code> methods handle determining the correct presenter to us, as well as paginating the collection where required.  They still use rails build in <code>#respond_with</code> method, which helps provide the correct response headers for each request.  As the ContactPresenter delegates <code>#errors</code> to its subject, if there are validation errors, <code>#respond_with</code> correctly returns a 422.</p>

<p>One further motivation for this pattern (other than moving presentation logic out of the model) is that should we want to release a new version of our API, we&rsquo;ll be able to get a lot of the way there simply by swapping which presenter is used.  We started using this code about 8 months ago, and I&rsquo;m still pretty happy with it.  I hope you find something useful in it too.</p>

<p>Any comments or suggestions, please get in touch with me <a href="http://twitter.com/tomafro">on twitter</a>.</p>

  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2011/08"> 2nd August 2011</a></span>
    <ul>
      <li><a href="/tags/hashblue" rel="tag">hashblue</a></li>
      <li><a href="/tags/gofreerange" rel="tag">gofreerange</a></li>
      <li><a href="/tags/o2" rel="tag">o2</a></li>
      <li><a href="/tags/api" rel="tag">api</a></li>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
    </ul>
  </footer>
</article>
<article>
  <header>
    <h1><a href="/2011/02/rails-mongo-instrumentation-gem">Mongo instrumentation released as a gem</a></h1>
  </header>
  <div class="content">
    <p>Enough people seemed to comment and like the mongo instrumentation code I wrote about yesterday that I&rsquo;ve packaged it up and released it as a gem.</p>

<p>The <a href="http://rubygems.org/gems/mongo-rails-instrumentation">mongo-rails-instrumentation</a> gem is available on rubygems, and the code is <a href="https://github.com/tomafro/mongo-rails-instrumentation">up on github</a>.</p>

<p>Adding it to a project is simple, just put the following in your <code>Gemfile</code>, run <code>bundle install</code> and restart your app.</p>

<div class="highlight"><pre>    <span class="n">gem</span> <span class="s1">&#39;mongo-rails-instrumentation&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt;0.1&#39;</span>
</pre>
</div>


<p>Please add any suggestions, improvements and comments to the code in github.  I hope people find it useful.</p>

  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2011/02">19th February 2011</a></span>
    <ul>
      <li><a href="/tags/ruby" rel="tag">ruby</a></li>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
      <li><a href="/tags/rails3" rel="tag">rails3</a></li>
      <li><a href="/tags/mongo" rel="tag">mongo</a></li>
      <li><a href="/tags/instrumentation" rel="tag">instrumentation</a></li>
    </ul>
  </footer>
</article>
<article>
  <header>
    <h1><a href="/2011/02/experimental-mongo-instrumentation">Experimental Mongo instrumentation (for Rails 3)</a></h1>
  </header>
  <div class="content">
    <div class="update">
Update: Changed to instrument methods on the Mongo::Connection
</div>


<p>One of our latest rails projects uses <a href="http://mongodb.org">Mongo</a> as a backend.  We&rsquo;re just starting to get some traffic, and as we do, we&rsquo;re monitoring the logs for slow requests.  When using ActiveRecord, rails splits out the recorded request time like so:</p>

<div class="highlight"><pre>    Completed 200 OK in 6ms <span class="o">(</span>Views 370.5ms | ActiveRecord: 2.3ms<span class="o">)</span>
</pre>
</div>


<p>We wanted to do the same for our Mongo accesses, just to give a rough idea as to what our requests were doing.  Luckily Rails 3 makes this relatively straightforward, providing hooks to instrument methods, subscribe to log messages and add information to the request log.  Here, then, is my first stab (mainly harvested from ActiveRecord):</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">Mongo</span>
  <span class="k">module</span> <span class="nn">Instrumentation</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">instrument</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="o">*</span><span class="nb">methods</span><span class="p">)</span>
      <span class="n">clazz</span><span class="o">.</span><span class="n">module_eval</span> <span class="k">do</span>
        <span class="nb">methods</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
          <span class="nb">class_eval</span> <span class="sx">%{def </span><span class="si">#{</span><span class="n">m</span><span class="si">}</span><span class="sx">_with_instrumentation(*args, &amp;block)</span>
<span class="sx">            ActiveSupport::Notifications.instrumenter.instrument &quot;mongo.mongo&quot;, :name =&gt; &quot;</span><span class="si">#{</span><span class="n">m</span><span class="si">}</span><span class="sx">&quot; do</span>
<span class="sx">              </span><span class="si">#{</span><span class="n">m</span><span class="si">}</span><span class="sx">_without_instrumentation(*args, &amp;block)</span>
<span class="sx">            end</span>
<span class="sx">          end</span>
<span class="sx">          }</span>

          <span class="n">alias_method_chain</span> <span class="n">m</span><span class="p">,</span> <span class="ss">:instrumentation</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Railtie</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Railtie</span>
      <span class="n">initializer</span> <span class="s2">&quot;mongo.instrumentation&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>
        <span class="no">Mongo</span><span class="o">::</span><span class="no">Instrumentation</span><span class="o">.</span><span class="n">instrument</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Connection</span><span class="p">,</span> <span class="ss">:send_message</span><span class="p">,</span> <span class="ss">:send_message_with_safe_check</span><span class="p">,</span> <span class="ss">:receive_message</span>

        <span class="no">ActiveSupport</span><span class="o">.</span><span class="n">on_load</span><span class="p">(</span><span class="ss">:action_controller</span><span class="p">)</span> <span class="k">do</span>
          <span class="kp">include</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Instrumentation</span><span class="o">::</span><span class="no">ControllerRuntime</span>
        <span class="k">end</span>

        <span class="no">Mongo</span><span class="o">::</span><span class="no">Instrumentation</span><span class="o">::</span><span class="no">LogSubscriber</span><span class="o">.</span><span class="n">attach_to</span> <span class="ss">:mongo</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">module</span> <span class="nn">ControllerRuntime</span>
      <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

      <span class="kp">protected</span>

      <span class="n">attr_internal</span> <span class="ss">:mongo_runtime</span>

      <span class="k">def</span> <span class="nf">cleanup_view_runtime</span>
        <span class="n">mongo_rt_before_render</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Instrumentation</span><span class="o">::</span><span class="no">LogSubscriber</span><span class="o">.</span><span class="n">reset_runtime</span>
        <span class="n">runtime</span> <span class="o">=</span> <span class="k">super</span>
        <span class="n">mongo_rt_after_render</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Instrumentation</span><span class="o">::</span><span class="no">LogSubscriber</span><span class="o">.</span><span class="n">reset_runtime</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">mongo_runtime</span> <span class="o">=</span> <span class="n">mongo_rt_before_render</span> <span class="o">+</span> <span class="n">mongo_rt_after_render</span>
        <span class="n">runtime</span> <span class="o">-</span> <span class="n">mongo_rt_after_render</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">append_info_to_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">super</span>
        <span class="n">payload</span><span class="o">[</span><span class="ss">:mongo_runtime</span><span class="o">]</span> <span class="o">=</span> <span class="n">mongo_runtime</span>
      <span class="k">end</span>

      <span class="k">module</span> <span class="nn">ClassMethods</span>
        <span class="k">def</span> <span class="nf">log_process_action</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
          <span class="n">messages</span><span class="p">,</span> <span class="n">mongo_runtime</span> <span class="o">=</span> <span class="k">super</span><span class="p">,</span> <span class="n">payload</span><span class="o">[</span><span class="ss">:mongo_runtime</span><span class="o">]</span>
          <span class="n">messages</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="s2">&quot;Mongo: %.1fms&quot;</span> <span class="o">%</span> <span class="n">mongo_runtime</span><span class="o">.</span><span class="n">to_f</span><span class="p">)</span> <span class="k">if</span> <span class="n">mongo_runtime</span>
          <span class="n">messages</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">LogSubscriber</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">LogSubscriber</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">runtime</span><span class="o">=</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">[</span><span class="s2">&quot;mongo_mongo_runtime&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">runtime</span>
        <span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">[</span><span class="s2">&quot;mongo_mongo_runtime&quot;</span><span class="o">]</span> <span class="o">||=</span> <span class="mi">0</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">reset_runtime</span>
        <span class="n">rt</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">rt</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">mongo</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">runtime</span> <span class="o">+=</span> <span class="n">event</span><span class="o">.</span><span class="n">duration</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>It looks complicated, but it&rsquo;s actually pretty simple.  Data access methods in <strike><code>Mongo::DB</code> and <code>Mongo::Collection</code></strike> <code>Mongo::Connection</code> are hijacked and surrounded by an <code>ActiveSupport::Notifications.instrumenter.instrument</code> block.  This triggers events which are listened to by the <code>LogSubscriber</code>, summing the total time spent in Mongo.  The <code>ControllerRuntime</code> then collects this count to be displayed, and resets the sum to zero ready for the next request.  The output looks like this:</p>

<div class="highlight"><pre>    Completed 200 OK in 838ms <span class="o">(</span>Views: 370.5ms | ActiveRecord: 2.3ms | Mongo: 441.5ms<span class="o">)</span>
</pre>
</div>


<p>It&rsquo;s just a first stab, so any comments and improvements are more then welcome.  It&rsquo;s <a href="https://gist.github.com/833444">here on gist</a> so please fork away.</p>

  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2011/02">18th February 2011</a></span>
    <ul>
      <li><a href="/tags/ruby" rel="tag">ruby</a></li>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
      <li><a href="/tags/rails3" rel="tag">rails3</a></li>
      <li><a href="/tags/mongo" rel="tag">mongo</a></li>
      <li><a href="/tags/instrumentation" rel="tag">instrumentation</a></li>
    </ul>
  </footer>
</article>
<article>
  <header>
    <h1><a href="/2011/02/rails-3-column-reader-tweak">A home for my Active Record column reader</a></h1>
  </header>
  <div class="content">
    <p><a href="http://twitter.com/kraykray">@kraykray</a> was nice enough to let me know that Rails 3.03 had broken my column-reader code.</p>

<p>I&rsquo;ve always seen it as a toy rather than a serious project, but getting a bug report made me re-evaluate.  If people are using it, even a tiny piece of code like this deserves a proper home.</p>

<p>So here it is, as both <a href="https://github.com/tomafro/rails-activerecord-columnreader">a github repository</a> and <a href="http://rubygems.org/gems/activerecord-column-reader">a gem</a>.  Enjoy!</p>

  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2011/02"> 8th February 2011</a></span>
    <ul>
      <li><a href="/tags/ruby" rel="tag">ruby</a></li>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
      <li><a href="/tags/rails3" rel="tag">rails3</a></li>
      <li><a href="/tags/active-record" rel="tag">active-record</a></li>
      <li><a href="/tags/column-reader" rel="tag">column-reader</a></li>
    </ul>
  </footer>
</article>
<article>
  <header>
    <h1><a href="/2010/02/updated-rails-template-for-bundler">An updated rails template for gem bundler</a></h1>
  </header>
  <div class="content">
    <div class="update">
<h3>Update 8th February 2011:</h3>
Bundler has changed a lot since I wrote these instructions.  Use them at your own risk!
</div>


<p>A few months ago I wrote <a href="http://tomafro.net/2009/11/a-rails-template-for-gem-bundler">a rails template for gem bundler</a>. Since then, bundler has changed a lot, and my template no longer works. <a href="http://github.com/tomafro/dotfiles/raw/master/resources/rails/bundler.rb">Here then is an updated version</a>, based on <a href="http://gist.github.com/302406">this gist</a> from <a href="http://arko.net/">Andre Arko</a>.  Using it, you should be able to get a rails 2.3.5 project working with bundler in less than 5 minutes.</p>

<p>The first step is to install the latest bundler.  At the time of writing, this was 0.9.9.</p>

<div class="highlight"><pre><span class="n">gem</span> <span class="n">install</span> <span class="n">bundler</span>
</pre>
</div>


<p>Now you should be able to run the template, either on a new project, or on an existing rails 2.3.5 project.</p>

<div class="highlight"><pre>rails -m http://github.com/tomafro/dotfiles/raw/master/resources/rails/bundler.rb &lt;project&gt;
</pre>
</div>


<p>On a fresh project, that should be all you need to do.  On an existing that used an older version of bundler, you&rsquo;ll need to remove the old hooks in <code>config/preinitializer.rb</code> and <code>config/environment.rb</code>, and the <code>gems</code> folder.</p>

<h3>Explaining the template, step by step</h3>


<p>The first step creates the project <code>Gemfile</code>, with rails available in all environments, and ruby-debug included in development.  If the project has other gems, they should be added here, rather than using rails own <code>config.gem</code> mechanism.</p>

<div class="highlight"><pre><span class="n">file</span> <span class="s1">&#39;Gemfile&#39;</span><span class="p">,</span> <span class="sx">%{</span>
<span class="sx">source &#39;http://rubygems.org&#39;</span>

<span class="sx">gem &#39;rails&#39;, &#39;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">STRING</span><span class="si">}</span><span class="sx">&#39;</span>

<span class="sx">group :development do</span>
<span class="sx">  gem &#39;ruby-debug&#39;</span>
<span class="sx">end</span>
<span class="sx">}</span><span class="o">.</span><span class="n">strip</span>
</pre>
</div>


<p>The next step is get bundler to load correctly.  This is done in two stages.  First, in <code>config\preinitializer.rb</code> bundler needs to be setup.  This adds all the bundled gems to the ruby load path, but doesn&rsquo;t initialise them.</p>

<div class="highlight"><pre>  
<span class="n">append_file</span> <span class="s1">&#39;/config/preinitializer.rb&#39;</span><span class="p">,</span> <span class="sx">%{</span>
<span class="sx">begin</span>
<span class="sx">  # Require the preresolved locked set of gems.</span>
<span class="sx">  require File.expand_path(&#39;../../.bundle/environment&#39;, __FILE__)</span>
<span class="sx">rescue LoadError</span>
<span class="sx">  # Fallback on doing the resolve at runtime.</span>
<span class="sx">  require &quot;rubygems&quot;</span>
<span class="sx">  require &quot;bundler&quot;</span>
<span class="sx">  if Bundler::VERSION &lt;= &quot;0.9.5&quot;</span>
<span class="sx">    raise RuntimeError, &quot;Bundler incompatible.</span><span class="se">\n</span><span class="sx">&quot; +</span>
<span class="sx">      &quot;Your bundler version is incompatible with Rails 2.3 and an unlocked bundle.</span><span class="se">\n</span><span class="sx">&quot; +</span>
<span class="sx">      &quot;Run `gem install bundler` to upgrade or `bundle lock` to lock.&quot;</span>
<span class="sx">  else</span>
<span class="sx">    Bundler.setup</span>
<span class="sx">  end</span>
<span class="sx">end</span>
<span class="sx">}</span><span class="o">.</span><span class="n">strip</span>
</pre>
</div>


<p>Second, the rails boot process is modified to start the bundler environment.  This &lsquo;requires&rsquo; all gems in the bundle, letting them run initialisation code.</p>

<div class="highlight"><pre><span class="n">gsub_file</span> <span class="s1">&#39;config/boot.rb&#39;</span><span class="p">,</span> <span class="s2">&quot;Rails.boot!&quot;</span><span class="p">,</span> <span class="sx">%{</span>
<span class="sx">  </span>
<span class="sx">class Rails::Boot</span>
<span class="sx"> def run</span>
<span class="sx">   load_initializer</span>
<span class="sx">   extend_environment</span>
<span class="sx">   Rails::Initializer.run(:set_load_path)</span>
<span class="sx"> end</span>

<span class="sx"> def extend_environment</span>
<span class="sx">   Rails::Initializer.class_eval do</span>
<span class="sx">     old_load = instance_method(:load_environment)</span>
<span class="sx">     define_method(:load_environment) do</span>
<span class="sx">       Bundler.require :default, Rails.env</span>
<span class="sx">       old_load.bind(self).call</span>
<span class="sx">     end</span>
<span class="sx">   end</span>
<span class="sx"> end</span>
<span class="sx">end</span>

<span class="sx">Rails.boot!</span>
<span class="sx">}</span>
</pre>
</div>


<p>All that&rsquo;s left now is a little cleaning up.  The <code>.bundle</code> folder should never be checked into the code repository as it holds machine-local configuration, so it&rsquo;s added to <code>.gitignore</code>.  Finally, <code>bundle install</code> is run to fetch the bundled gems.</p>

<div class="highlight"><pre><span class="n">append_file</span> <span class="s1">&#39;/.gitignore&#39;</span><span class="p">,</span> <span class="sx">%{</span>
<span class="sx">/.bundle</span>
<span class="sx">}</span>

<span class="n">run</span> <span class="s1">&#39;bundle install&#39;</span>
</pre>
</div>


<p>And that&rsquo;s it.  I hope you find it useful.</p>

  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2010/02">28th February 2010</a></span>
    <ul>
      <li><a href="/tags/ruby" rel="tag">ruby</a></li>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
      <li><a href="/tags/gem" rel="tag">gem</a></li>
      <li><a href="/tags/bundler" rel="tag">bundler</a></li>
    </ul>
  </footer>
</article>
<article>
  <header>
    <h1><a href="/2010/02/rails-3-direct-column-reader">Rails 3 direct column reader</a></h1>
  </header>
  <div class="content">
    <p>Whilst trying to get my head around <a href="http://github.com/brynary/arel">arel</a> and it&rsquo;s relationship to ActiveRecord in rails 3, I&rsquo;ve updated the simple ColumnReader class I <a href="http://tomafro.net/2009/05/read-active-record-columns-directly-from-the-class">introduced last year</a>.  It lets you read the (correctly cast) column values for an ActiveRecord class, without the overhead of instantiating each object.</p>

<p>Here&rsquo;s the updated code:</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">ColumnReader</span>
  <span class="k">def</span> <span class="nf">column_reader</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="nb">name</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:as</span><span class="p">)</span> <span class="o">||</span> <span class="n">column_name</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">pluralize</span>
    <span class="n">column</span> <span class="o">=</span> <span class="n">columns_hash</span><span class="o">[</span><span class="n">column_name</span><span class="o">.</span><span class="n">to_s</span><span class="o">]</span>
  
    <span class="nb">self</span><span class="o">.</span><span class="n">module_eval</span> <span class="sx">%{</span>
<span class="sx">      def self.</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx"></span>
<span class="sx">        query = scoped.arel.project(arel_table[:</span><span class="si">#{</span><span class="n">column_name</span><span class="si">}</span><span class="sx">])</span>
<span class="sx">        connection.select_all(query.to_sql).collect do |value| </span>
<span class="sx">          v = value.values.first</span>
<span class="sx">          </span><span class="si">#{</span><span class="n">column</span><span class="o">.</span><span class="n">type_cast_code</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)</span><span class="si">}</span><span class="sx"></span>
<span class="sx">        end</span>
<span class="sx">      end</span>
<span class="sx">    }</span>
  <span class="k">end</span>

  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
<span class="k">end</span>
</pre>
</div>


<p>The code isn&rsquo;t that different, though using <code>scoped</code> over <code>construct_finder_sql</code> feels a lot nicer.  If you&rsquo;ve got suggestions for improvement <a href="http://gist.github.com/301420">gist away</a>.</p>

<p>Usage is similar to before, only using the new rails 3 syntax:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Animal</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">column_reader</span> <span class="s1">&#39;id&#39;</span>
  <span class="n">column_reader</span> <span class="s1">&#39;name&#39;</span>  
 
  <span class="n">named_scope</span> <span class="ss">:dangerous</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:carnivorous</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">}</span> 
<span class="k">end</span>

<span class="no">Animal</span><span class="o">.</span><span class="n">names</span> 
<span class="c1">#=&gt; [&#39;Lion&#39;, &#39;Tiger&#39;, &#39;Zebra&#39;, &#39;Gazelle&#39;]</span>
 
<span class="no">Animal</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">names</span> 
<span class="c1">#=&gt; [&#39;Lion&#39;] (Normal finder options supported)</span>
 
<span class="no">Animal</span><span class="o">.</span><span class="n">dangerous</span><span class="o">.</span><span class="n">names</span> 
<span class="c1">#=&gt; [&#39;Lion&#39;, &#39;Tiger&#39;] (Scoping respected)</span>
 
<span class="no">Animal</span><span class="o">.</span><span class="n">ids</span>
<span class="c1">#=&gt; [1, 2, 3] (Values cast correctly)</span>
</pre>
</div>


<p>I&rsquo;m still not entirely convinced of the value of this helper, so if you find a good use <a href="http://twitter.com/tomafro">tweet me</a>.  Enjoy!</p>

  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2010/02">11th February 2010</a></span>
    <ul>
      <li><a href="/tags/ruby" rel="tag">ruby</a></li>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
      <li><a href="/tags/rails3" rel="tag">rails3</a></li>
      <li><a href="/tags/active-record" rel="tag">active-record</a></li>
      <li><a href="/tags/column-reader" rel="tag">column-reader</a></li>
    </ul>
  </footer>
</article>
<article>
  <header>
    <h1><a href="/2010/01/how-to-use-rails3-gems-now">How to easily use Rails 3 now</a></h1>
  </header>
  <div class="content">
    <div class="update">
<h3>Update 10th February 2010:</h3>
The instructions below were useful earlier in the development cycle.  Now the <a href="http://weblog.rubyonrails.org/2010/2/5/rails-3-0-beta-release">beta gem has been released</a>, the process is much easier:


<div class="highlight"><pre>gem uninstall bundler
gem install tzinfo builder memcache-client rack rack-test rack-mount 
gem install erubis mail text-format thor bundler i18n
gem install rails --pre
</pre>
</div>

</div>


<p>Now that rails 3 is getting closer to release, I wanted to start playing around with it.  I&rsquo;ve seen a few articles on getting it up and running, but they all seemed a little bit complicated.  To use rails 2.3.5 before its release, I just built the gems myself and installed them.  It turns out you can easily do the same with rails 3.</p>

<p>First, install rails main dependencies:</p>

<div class="highlight"><pre>gem install rake rack bundler
gem install arel --version 0.2.pre
</pre>
</div>


<p>Next, get the latest rails code from github, and install the rails gems.  There may be a few errors you can safely ignore:</p>

<div class="highlight"><pre>git clone git://github.com/rails/rails.git
<span class="nb">cd </span>rails
rake install
</pre>
</div>


<p>And bang, you can start your first rails 3 project:</p>

<div class="highlight"><pre>rails ~/apps/playground/rails3 
</pre>
</div>


<p>Your existing projects shouldn&rsquo;t be affected as rails is installed as a prerelease gem, but to be safe I&rsquo;d recommend a tool like <a href="http://rvm.beginrescueend.com/">rvm</a> to switch to a clean set of gems.</p>

  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2010/01">24th January 2010</a></span>
    <ul>
      <li><a href="/tags/ruby" rel="tag">ruby</a></li>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
      <li><a href="/tags/rails3" rel="tag">rails3</a></li>
      <li><a href="/tags/gems" rel="tag">gems</a></li>
    </ul>
  </footer>
</article>
<article>
  <header>
    <h1><a href="/2009/11/building-gems-from-a-rails-branch">Building rails gems from the 2-3-stable branch</a></h1>
  </header>
  <div class="content">
    <p>For the latest application I&rsquo;ve been working on, I wanted to use <a href="http://github.com/NZKoz/rails_xss/">Michael Koziarski&rsquo;s rails_xss plugin</a>, to turn default escaping on in my erb templates.  I&rsquo;m also using <a href="http://github.com/wycats/bundler/">wycats gem bundler</a> to manage gems and their dependencies, including rails.</p>

<p>This posed a problem: xss_rails requires changes made in rails 2-3-stable branch, but not yet released in a gem (though they will be included in 2.3.5).</p>

<p>The solution was obvious: build my own gems, and get bundler to use them.  Luckily, rails makes this an easy process.</p>

<p>First, clone rails from github, and change to the 2-3-stable branch:</p>

<div class="highlight"><pre>git clone git://github.com/rails/rails.git
<span class="nb">cd </span>rails
git co -b 2-3-stable origin/2-3-stable
</pre>
</div>


<p>Next, we need to build the gems.  Rails currently doesn&rsquo;t seem to have a Raketask to build all its constituent projects (though I&rsquo;m planning a patch to include one), so you have to build each one in turn:</p>

<div class="highlight"><pre><span class="nb">cd </span>actionmailer
rake gem <span class="nv">PKG_BUILD</span><span class="o">=</span>1
<span class="nb">cd</span> ../actionpack
rake gem <span class="nv">PKG_BUILD</span><span class="o">=</span>1
<span class="nb">cd</span> ../activerecord
rake gem <span class="nv">PKG_BUILD</span><span class="o">=</span>1
<span class="nb">cd</span> ../activeresource
rake gem <span class="nv">PKG_BUILD</span><span class="o">=</span>1
<span class="nb">cd</span> ../activesupport
rake gem <span class="nv">PKG_BUILD</span><span class="o">=</span>1
<span class="nb">cd</span> ../railties
rake gem <span class="nv">PKG_BUILD</span><span class="o">=</span>1
<span class="nb">cd</span> ..
</pre>
</div>


<p>The key is the <code>PKG_BUILD</code> variable.  It appends a suffix to the rails version, so rather than building 2.3.4 (the version I checked out), it will build 2.3.4.1.  If I decided to update my gems, I&rsquo;d use PKG_BUILD=2, then 3 and so on.</p>

<p>Finally, once all these gems are built, it&rsquo;s simply a case of finding them and using them.  For gem bundler, this means placing them in the cache and updating the Gemfile to look for rails &lsquo;2.3.4.1&rsquo;.  The gems are all built in pkg folders in their respective subprojects, so to copy them all somewhere else you can run:</p>

<div class="highlight"><pre>cp **/pkg/*.gem &lt;project-folder&gt;/gems/cache
</pre>
</div>


  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2009/11"> 5th November 2009</a></span>
    <ul>
      <li><a href="/tags/ruby" rel="tag">ruby</a></li>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
      <li><a href="/tags/gem" rel="tag">gem</a></li>
      <li><a href="/tags/bundler" rel="tag">bundler</a></li>
    </ul>
  </footer>
</article>
<article>
  <header>
    <h1><a href="/2009/11/a-rails-template-for-gem-bundler">A rails template for gem bundler</a></h1>
  </header>
  <div class="content">
    <div class="update">
<h3>Update 28th February 2010:</h3>
Bundler has changed a lot since I first wrote this template, so I've <a href="/2010/02/updated-rails-template-for-gem-bundler">written a new version</a>.  Please use the updated version rather than the one below.
</div>


<p>Following Nick Quaranto&rsquo;s article <a href="http://litanyagainstfear.com/blog/2009/10/14/gem-bundler-is-the-future/">&lsquo;Gem Bundler is the Future&rsquo;</a>, I was inspired to try out <a href="http://github.com/wycats/bundler">bundler</a> on my latest rails project.  Previously, I&rsquo;ve found rails' own gem management a massive headache.  In contrast, using bundler has been a pleasure.</p>

<p>Getting it set up how I wanted took a fair bit of experimentation, so to make things easier both for me and the wider community, I&rsquo;ve  made a rails template to do the hard work.</p>

<p>Give it a try by running the following. You should be up and running in a couple of minutes:</p>

<div class="highlight"><pre>rails -m http://github.com/tomafro/dotfiles/raw/master/resources/rails/bundler.rb &lt;project&gt;
</pre>
</div>


<p>That will give you a bundled project, ready for you to add your own gems.  Here&rsquo;s what each step of the template actually does:</p>

<p>Gem bundler is itself a gem.  It can&rsquo;t be used to manage itself, so to ensure that all environments use the same version, the first step is to install it right into the project:</p>

<div class="highlight"><pre><span class="n">inside</span> <span class="s1">&#39;gems/bundler&#39;</span> <span class="k">do</span>  
  <span class="n">run</span> <span class="s1">&#39;git init&#39;</span>
  <span class="n">run</span> <span class="s1">&#39;git pull --depth 1 git://github.com/wycats/bundler.git&#39;</span> 
  <span class="n">run</span> <span class="s1">&#39;rm -rf .git .gitignore&#39;</span>
<span class="k">end</span>
</pre>
</div>


<p>Just having bundler installed is no good without any way to run it; a script is needed.  Once this is installed the local bundler can be run with <code>script/bundle &lt;options&gt;</code>:</p>

<div class="highlight"><pre><span class="n">file</span> <span class="s1">&#39;script/bundle&#39;</span><span class="p">,</span> <span class="sx">%{</span>
<span class="sx">#!/usr/bin/env ruby</span>
<span class="sx">path = File.expand_path(File.join(File.dirname(__FILE__), &quot;..&quot;, &quot;gems/bundler/lib&quot;))</span>
<span class="sx">$LOAD_PATH.unshift path</span>
<span class="sx">require &#39;rubygems&#39;</span>
<span class="sx">require &#39;rubygems/command&#39;</span>
<span class="sx">require &#39;bundler&#39;</span>
<span class="sx">require &#39;bundler/commands/bundle_command&#39;</span>
<span class="sx">Gem::Commands::BundleCommand.new.invoke(*ARGV)</span>
<span class="sx">}</span><span class="o">.</span><span class="n">strip</span>

<span class="n">run</span> <span class="s1">&#39;chmod +x script/bundle&#39;</span>
</pre>
</div>


<p>Bundler uses Gemfiles to declare which gems are required in each environment.  This simple <code>Gemfile</code> includes rails in all environments, and ruby-debug in all environments other than production:</p>

<div class="highlight"><pre><span class="n">file</span> <span class="s1">&#39;Gemfile&#39;</span><span class="p">,</span> <span class="sx">%{</span>
<span class="sx">clear_sources</span>
<span class="sx">source &#39;http://gemcutter.org&#39;</span>

<span class="sx">disable_system_gems</span>

<span class="sx">bundle_path &#39;gems&#39;</span>

<span class="sx">gem &#39;rails&#39;, &#39;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">STRING</span><span class="si">}</span><span class="sx">&#39;</span>
<span class="sx">gem &#39;ruby-debug&#39;, :except =&gt; &#39;production&#39;</span>
<span class="sx">}</span><span class="o">.</span><span class="n">strip</span>
</pre>
</div>


<p>Most of the files bundler will place in the <code>gem</code> path can be regenerated; they shouldn&rsquo;t be added to the project repository.  The only things that should be added are the <code>.gem</code> files themselves, and the local copy of bundler.  All the rest should be ignored:</p>

<div class="highlight"><pre><span class="n">append_file</span> <span class="s1">&#39;.gitignore&#39;</span><span class="p">,</span> <span class="sx">%{</span>
<span class="sx">gems/*</span>
<span class="sx">!gems/cache</span>
<span class="sx">!gems/bundler}</span>
</pre>
</div>


<p>The bundle script needs to be run for the first time:</p>

<div class="highlight"><pre><span class="n">run</span> <span class="s1">&#39;script/bundle&#39;</span>
</pre>
</div>


<p>Finally rails needs to be modified to ensure the bundler environment is loaded.  This is done it two parts.  First, a preinitializer is added to load the bundler&rsquo;s environment file before anything else:</p>

<div class="highlight"><pre><span class="n">append_file</span> <span class="s1">&#39;/config/preinitializer.rb&#39;</span><span class="p">,</span> <span class="sx">%{</span>
<span class="sx">require File.expand_path(File.join(File.dirname(__FILE__), &quot;..&quot;, &quot;gems&quot;, &quot;environment&quot;))</span>
<span class="sx">}</span>
</pre>
</div>


<p>Second, rails initialization process is hijacked to require the correct bundler environment:</p>

<div class="highlight"><pre><span class="n">gsub_file</span> <span class="s1">&#39;config/environment.rb&#39;</span><span class="p">,</span> <span class="s2">&quot;require File.join(File.dirname(__FILE__), &#39;boot&#39;)&quot;</span><span class="p">,</span> <span class="sx">%{</span>
<span class="sx">require File.join(File.dirname(__FILE__), &#39;boot&#39;)</span>

<span class="sx"># Hijack rails initializer to load the bundler gem environment before loading the rails environment.</span>

<span class="sx">Rails::Initializer.module_eval do</span>
<span class="sx">  alias load_environment_without_bundler load_environment</span>
<span class="sx">  </span>
<span class="sx">  def load_environment</span>
<span class="sx">    Bundler.require_env configuration.environment</span>
<span class="sx">    load_environment_without_bundler</span>
<span class="sx">  end</span>
<span class="sx">end</span>
<span class="sx">}</span>
</pre>
</div>


<p>And that&rsquo;s it.  The project is now fully bundled.  More gems can be added to the <code>Gemfile</code> and pulled into the project with <code>script/bundle</code>.</p>

  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2009/11"> 3rd November 2009</a></span>
    <ul>
      <li><a href="/tags/ruby" rel="tag">ruby</a></li>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
      <li><a href="/tags/gem" rel="tag">gem</a></li>
      <li><a href="/tags/bundler" rel="tag">bundler</a></li>
    </ul>
  </footer>
</article>
<article>
  <header>
    <h1><a href="/2009/09/tip-the-case-for-from-param">Tip: The case for from_param</a></h1>
  </header>
  <div class="content">
    <p>There&rsquo;s one small method I add to every new rails project I work on:</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">Tomafro::FromParam</span>
  <span class="k">def</span> <span class="nf">from_param</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">first</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">primary_key</span> <span class="o">=&gt;</span> <span class="n">param</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="no">Tomafro</span><span class="o">::</span><span class="no">FromParam</span><span class="p">)</span>
</pre>
</div>


<p>In my controllers, where you might use <code>Model.find(params[:id])</code> or <code>Model.find_by_id(params[:id)</code>, I use <code>Model.from_param(params[:id])</code> instead.</p>

<p>All three methods have almost the same behaviour, the only difference being the handling of missing records.  <code>find</code> throws a RecordNotFound, while <code>find_by_id</code> and <code>from_param</code> return nil.  So why use <code>from_param</code> over the others?</p>

<p>The answer comes when you want to change <code>to_param</code>, the method rails uses to turn a record into a parameter.  It&rsquo;s a good principal (though often broken) not to expose database ids in urls.  An example might be to use a users nickname rather than their id in user urls, so <code>/users/12452</code> becomes <code>/users/tomafro</code>.  In rails this is easy to achieve, by overriding the <code>to_param</code> method:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">to_param</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">nickname</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>Rails will automatically use this method when generating routes, so <code>users_path(@user)</code> will return <code>/users/tomafro</code> as we&rsquo;d like.  If I was using <code>find</code> or <code>find_by_id</code> in my controllers, I&rsquo;d then have to go through each one and change it to <code>find_by_nickname</code>.  Luckily though, I&rsquo;ve used <code>from_param</code>, so whenever I override <code>to_param</code> I just have to remember to provide an equivalent implementation for <code>from_param</code>, and my controllers will work without modification:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_param</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">first</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:nickname</span> <span class="o">=&gt;</span> <span class="n">param</span><span class="p">}</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">to_param</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">nickname</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>I&rsquo;ve been doing this for years, but it&rsquo;s hardly a new principle, to provide a <code>from</code> method for every <code>to</code> method.  There&rsquo;s <a href="http://dev.rubyonrails.org/ticket/11505">even an old ticket on trac</a> asking for it, but it&rsquo;s been considered too trivial to add.</p>

<p>I disagree &ndash; for me the value comes from having the method from the start, not when you need it.  Luckily it&rsquo;s easy to add to my own projects.</p>

  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2009/09">23rd September 2009</a></span>
    <ul>
      <li><a href="/tags/tip" rel="tag">tip</a></li>
      <li><a href="/tags/ruby" rel="tag">ruby</a></li>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
      <li><a href="/tags/active-record" rel="tag">active-record</a></li>
      <li><a href="/tags/from-param" rel="tag">from-param</a></li>
    </ul>
  </footer>
</article>
<article>
  <header>
    <h1><a href="/2009/09/quickly-list-missing-foreign-key-indexes">Quickly list missing foreign key indexes</a></h1>
  </header>
  <div class="content">
    <p>Run this code in a rails console to list foreign keys which aren&rsquo;t indexed.</p>

<div class="highlight"><pre><span class="n">c</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span>
<span class="n">c</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>  
  <span class="n">columns</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">ends_with?</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span> <span class="o">||</span> <span class="n">x</span><span class="o">.</span><span class="n">ends_with</span><span class="p">(</span><span class="s2">&quot;_type&quot;</span><span class="p">))}</span>
  <span class="n">indexed_columns</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">indexes</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:columns</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">uniq</span>
  <span class="n">unindexed</span> <span class="o">=</span> <span class="n">columns</span> <span class="o">-</span> <span class="n">indexed_columns</span>
  <span class="k">unless</span> <span class="n">unindexed</span><span class="o">.</span><span class="n">empty?</span>
    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">t</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">unindexed</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>This list will look something like this:</p>

<div class="highlight"><pre>attachments: parent_id, asset_id
domain_names: organisation_id
event_memberships: user_id, event_id
events: editor_id
group_actions: user_id, group_id
groups: user_id
icons: parent_id
invitations: sender_id
legacy_actions: item_upon_id
news_items: author_id
organisations: midas_id
pages: author_id
pending_event_memberships: invitation_id, event_id
resources: user_id, resourceable_id
subscriptions: subscribable_id, user_id
taggings: tag_id, taggable_id, user_id
</pre>
</div>


<p>For each column in the list, ask yourself why you don&rsquo;t need an index.</p>

<p><em>Update:</em> Andrew Coleman has <a href="http://penguincoder.org/pages/A_Slightly_Better_Way_To_Find_Missing_Foreign_Key_Indexes">added output in migration format</a>.  If you want to play around with it further, <a href="http://gist.github.com/191181">here&rsquo;s the original code on gist</a>.</p>

  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2009/09">22nd September 2009</a></span>
    <ul>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
      <li><a href="/tags/databases" rel="tag">databases</a></li>
      <li><a href="/tags/indexes" rel="tag">indexes</a></li>
      <li><a href="/tags/sql" rel="tag">sql</a></li>
      <li><a href="/tags/code" rel="tag">code</a></li>
    </ul>
  </footer>
</article>
<article>
  <header>
    <h1><a href="/2009/08/using-indexes-in-rails-choosing-additional-indexes">Using indexes in rails: Choosing additional indexes</a></h1>
  </header>
  <div class="content">
    <p><a href="http://tomafro.net/2009/08/using-indexes-in-rails-index-your-associations">The first part in this series of posts</a> looked at adding indexes to foreign keys, to improve the performance when navigating rails associations.  But many queries involve data other than just foreign keys.  With the judicious use of indexes, we can improve these too.</p>

<p>Let&rsquo;s take the <code>conversations</code> table used in the first article, and add a column to hold the language, and some timestamps.  Here&rsquo;s the full schema:</p>

<div class="highlight"><pre><span class="n">create_table</span> <span class="n">conversations</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
  <span class="n">table</span><span class="o">.</span><span class="n">string</span>   <span class="ss">:subject</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="n">table</span><span class="o">.</span><span class="n">integer</span>  <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="n">table</span><span class="o">.</span><span class="n">integer</span>  <span class="ss">:subject_id</span>
  <span class="n">table</span><span class="o">.</span><span class="n">string</span>   <span class="ss">:subject_type</span>
  <span class="n">table</span><span class="o">.</span><span class="n">string</span>   <span class="ss">:language_code</span>
  <span class="n">table</span><span class="o">.</span><span class="n">datetime</span> <span class="ss">:created_at</span>
  <span class="n">table</span><span class="o">.</span><span class="n">datetime</span> <span class="ss">:updated_at</span>
<span class="k">end</span>
</pre>
</div>


<p>We want to split conversations by their languages, so we&rsquo;ll add a <code>named_scope</code> to the Conversation class:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Conversation</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">belongs_to</span> <span class="ss">:subject</span><span class="p">,</span> <span class="ss">:polymorphic</span> <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="n">named_scope</span> <span class="ss">:in_language</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span><span class="o">|</span><span class="n">language</span><span class="o">|</span>
    <span class="p">{</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:language_code</span> <span class="o">=&gt;</span> <span class="n">language</span><span class="p">}}</span>
  <span class="p">}</span>
<span class="k">end</span>
</pre>
</div>


<p>Using <code>Conversation.in_language 'en'</code> will now get us all conversations in English.  Like we did for foreign keys, we can see how long the query takes and read the explain plan.</p>

<pre>mysql> SELECT * FROM conversations WHERE language_code = 'en';
90791 rows in set (3.94 sec)

mysql> EXPLAIN SELECT * FROM conversations WHERE language_code = 'en';
+-------------+------+---------------+---------+-------+---------+-------------+
| select_type | type | key           | key_len | ref   | rows    | Extra       |
+-------------+------+---------------+---------+-------+---------+-------------+
| SIMPLE      | ref  | NULL          | NULL    | NULL  | 1000111 | Using where |
+-------------+------+---------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)
</pre>


<p>Adding an index to the <code>language_code</code> column should improve the query performance, so let&rsquo;s do that and see the effect on our query:</p>

<pre>mysql> SELECT * FROM conversations WHERE language_code = 'en';
90791 rows in set (3.02 sec)

mysql> EXPLAIN SELECT * FROM conversations WHERE language_code = 'en';
+-------------+------+---------------+---------+-------+---------+-------------+
| select_type | type | key           | key_len | ref   | rows    | Extra       |
+-------------+------+---------------+---------+-------+---------+-------------+
| SIMPLE      | ref  | lang_code_ix  | 3       | const |   98345 | Using where |
+-------------+------+---------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)
</pre>


<p>So the query now uses the index, and the time taken has gone from almost 4 seconds to just over 3.  That&rsquo;s not nearly as big a performance gain as before, but why?  The answer is in the number of rows returned: 90791.  The index helps the database find the relevant rows quickly.  However, it still has to read those rows, and reading over 90,000 rows will always take a significant amount of time.</p>

<p>In a real app we&rsquo;re unlikely to want to read all these rows at once, so let&rsquo;s do another quick comparison limiting the query to the first 100 rows:</p>

<pre>Without the index:

mysql> SELECT * FROM conversations WHERE language_code = 'en' LIMIT 100;
100 rows in set (1.32 sec)

And with the index:

mysql> SELECT * FROM conversations WHERE language_code = 'en' LIMIT 100;
100 rows in set (0.01 sec)
</pre>


<p>Much better.</p>

<h3>Choosing between indexes</h3>

<p>We&rsquo;ve seen that by using an index and limiting the number of results we can quickly get the &lsquo;first&rsquo; 100 English conversations.  But in this case &lsquo;first&rsquo; doesn&rsquo;t really mean anything.  When no order clause is specified, MySQL may appear to order its results by id, but this is just a coincidence and shouldn&rsquo;t be relied on.  Let&rsquo;s instead order our results by <code>created_at</code> to get the 100 most recent conversations.</p>

<pre>mysql> SELECT * FROM conversations WHERE language_code = 'en' ORDER BY created_at DESC;
100 rows in set (4.42 sec)

mysql> EXPLAIN SELECT * FROM conversations WHERE language_code = 'en' ORDER BY created_at DESC;
+-------------+------+---------------+---------+-------+---------+-----------------------------+
| select_type | type | key           | key_len | ref   | rows    | Extra                       |
+-------------+------+---------------+---------+-------+---------+-----------------------------+
| SIMPLE      | ref  | lang_code_ix  | 3       | const |   98345 | Using where; using filesort |
+-------------+------+---------------+---------+-------+---------+-----------------------------+
1 row in set (0.00 sec)
</pre>


<p>Even though this query uses our index and only returns 100 rows, it has still taken almost 4.5 seconds!  The reason for this terrible performance is hinted in the extra information in the explain plan: <code>using filesort</code>.  The database is reading all rows that match the condition (all 90791 of them), then using a filesort to order them before returning the first 100.</p>

<p>If we add an index on <code>created_at</code> and do the query again we get:</p>

<pre>mysql> SELECT * FROM conversations WHERE language_code = 'en' ORDER BY created_at DESC;
100 rows in set (4.39 sec)

mysql> EXPLAIN SELECT * FROM conversations WHERE language_code = 'en' ORDER BY created_at DESC;
+-------------+------+---------------+---------+-------+---------+-----------------------------+
| select_type | type | key           | key_len | ref   | rows    | Extra                       |
+-------------+------+---------------+---------+-------+---------+-----------------------------+
| SIMPLE      | ref  | lang_code_ix  | 3       | const |   98345 | Using where; using filesort |
+-------------+------+---------------+---------+-------+---------+-----------------------------+
1 row in set (0.00 sec)
</pre>


<p>It&rsquo;s pretty much exactly the same &ndash; still almost 4.5 seconds.  This is because MySQL can only use one index per table in a query.  It has to choose between the index on <code>language_code</code> and the one on <code>created_at</code>, and in this case chooses the language code index.  We can force it to use our other index for comparison:</p>

<pre>mysql> SELECT * FROM conversations
       USE INDEX(created_ix) WHERE language_code = 'en'
       ORDER BY created_at DESC LIMIT 100;
100 rows in set (0.02 sec)

mysql> EXPLAIN SELECT * FROM conversations
       USE INDEX(created_ix) WHERE language_code = 'en'
       ORDER BY created_at DESC LIMIT 100;
+-------------+------+---------------+---------+-------+---------+-----------------------------+
| select_type | type | key           | key_len | ref   | rows    | Extra                       |
+-------------+------+---------------+---------+-------+---------+-----------------------------+
| SIMPLE      | ref  | created_ix    | 8       | const | 9903411 | Using where                 |
+-------------+------+---------------+---------+-------+---------+-----------------------------+
1 row in set (0.00 sec)
</pre>


<p>Using a trick stolen from <a href="http://m.onkey.org/2009/8/6/use-index-with-active-record-finders">Pratik Naik (in the comments of his article)</a> we can force the use of a particular index in rails with a special named scope, and perform our query:</p>

<div class="highlight"><pre><span class="no">Conversation</span><span class="o">.</span><span class="n">named_scope</span> <span class="ss">:use_index</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span><span class="o">|</span><span class="n">index</span><span class="o">|</span>
  <span class="p">{</span><span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">quoted_table_name</span><span class="si">}</span><span class="s2"> USE INDEX(</span><span class="si">#{</span><span class="n">index</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">}</span>
<span class="p">}</span>

<span class="no">Conversation</span><span class="o">.</span><span class="n">in_language</span><span class="p">(</span><span class="s1">&#39;en&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">use_index</span><span class="p">(</span><span class="s1">&#39;created_ix&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s1">&#39;created_at desc&#39;</span><span class="p">)</span>
</pre>
</div>


<p>But there is also another way &ndash; using indexing multiple columns.</p>

<h3>Using compound indexes</h3>

<p>A compound index indexes across two or more columns.  When defining a compound index, the order of the columns is significant, as the database reduces the set of candidate rows by comparing the columns in turn.  So an index created with <code>add_index :conversations, [:language_code, :created_at]</code> will compare <code>language_code</code> first, then <code>created_at</code>.</p>

<p>Because of this, we need to take some care in choosing the order of our columns.  In general, the rule is to specify the most selective column first.  That is, the column with the most unique values.  So for our query, we&rsquo;ll add the following:</p>

<div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:conversations</span><span class="p">,</span> <span class="o">[</span><span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:language_code</span><span class="o">]</span>
</pre>
</div>


<p>If we explain the query without forcing the index we find it is still efficient:</p>

<pre>mysql> EXPLAIN SELECT * FROM conversations
       WHERE language_code = 'en'
       ORDER BY created_at DESC LIMIT 100;
+-------------+------+----------------+---------+-------+---------+-----------------------------+
| select_type | type | key            | key_len | ref   | rows    | Extra                       |
+-------------+------+----------------+---------+-------+---------+-----------------------------+
| SIMPLE      | ref  | lang_and_ca_ix |      48 | const |  640231 | Using where                 |
+-------------+------+----------------+---------+-------+---------+-----------------------------+
1 row in set (0.00 sec)
</pre>


<h3>A technique for choosing index column order</h3>

<p>Sometimes it&rsquo;s hard to know which order your columns should be in an index, but there&rsquo;s an easy way to get a rough idea.  Rewrite the query, removing all conditions, and selecting <code>count(distinct column_to_index)</code> for each column.  So for our query, we&rsquo;d do the following:</p>

<pre>mysql> SELECT count(distinct language_code), count(distinct created_at)
       FROM conversations;
+-------------------------------+----------------------------+
| count(distinct language_code) | count(distinct created_at) |
+-------------------------------+----------------------------+
|                            21 |                     584089 |
+-------------------------------+----------------------------+
1 row in set (1.90 sec)
</pre>


<p>From this it&rsquo;s clear that there are more distinct created_at values, so we probably want to index this column first.  Note though that I said probably.  When deciding on indexes, there are no hard and fast rules.  Instead, we need to measure and analyse the queries used in our particular app, to ensure we are using the best indexes.</p>

<p>The next (and last) article in the series will go through some more advanced techniques, including when not to add an index, and how to spot redundant indexes.</p>

  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2009/08">18th August 2009</a></span>
    <ul>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
      <li><a href="/tags/databases" rel="tag">databases</a></li>
      <li><a href="/tags/indexes" rel="tag">indexes</a></li>
      <li><a href="/tags/sql" rel="tag">sql</a></li>
      <li><a href="/tags/using-indexes-in-rails" rel="tag">using-indexes-in-rails</a></li>
    </ul>
  </footer>
</article>
<article>
  <header>
    <h1><a href="/2009/08/using-indexes-in-rails-index-your-associations">Using indexes in rails: Index your associations</a></h1>
  </header>
  <div class="content">
    <p>Many rails developers are great at building applications but have limited experience in database design.  As a consequence, projects often have half-baked indexing strategies, and as a result suffer bad performance.</p>

<p>To try and improve this I&rsquo;ve planned a series of posts on indexes, targetted at rails developers.  In this first post I&rsquo;ll <a href="/2009/08/using-indexes-in-rails-index-your-associations">introduce indexes and how to index your associations</a>, then I&rsquo;ll write about choosing additional indexes to improve query performance, and finally how to avoid redundant and duplicate indexes.</p>

<h3>A brief overview of database indexes</h3>

<p><a href="http://en.wikipedia.org/wiki/Index_(database)">Wikipedia states that</a> &lsquo;a database index is a data structure that improves the speed of operations on a database table&rsquo;.  Unfortunately, this improvement comes at a cost.</p>

<p>For every index on a table, there is a penalty both when inserting and updating rows.  Indexes also take up space on disk and in memory, which can affect the efficiency of queries.  Finally, having too many indexes can cause databases to choose between them poorly, actually harming performance rather than improving it.</p>

<p>So while indexing is important, we shouldn&rsquo;t just throw indexes at our slow queries: we need to choose carefully how to index our data.</p>

<h3>Indexing simple associations</h3>

<p>By far the most common performance problem I&rsquo;ve encountered in rails projects is a lack of indexes on foreign keys.  There&rsquo;s no real excuse for this &ndash; not indexing foreign keys can cripple your app.</p>

<p>Take the following schema:</p>

<div class="highlight"><pre><span class="n">create_table</span> <span class="n">users</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
  <span class="n">table</span><span class="o">.</span><span class="n">string</span> <span class="ss">:login</span>
<span class="k">end</span>

<span class="n">create_table</span> <span class="n">conversations</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
  <span class="n">table</span><span class="o">.</span><span class="n">string</span>  <span class="ss">:subject</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="n">table</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
<span class="k">end</span>
</pre>
</div>


<p>We can use this to map a one-to-many relationship between users and conversations, where <code>user_id</code> as the foreign key.</p>

<p>Here are the models to do that:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:conversations</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Conversation</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span>
</pre>
</div>


<p>With these models, to find all conversations for a particular user we&rsquo;d use <code>user.conversations</code>, which in turns uses sql like this:</p>

<div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">conversations</span> <span class="k">WHERE</span> <span class="n">user_id</span> <span class="o">=</span> <span class="mi">41</span><span class="p">;</span>
</pre>
</div>


<p>I can run this query on a test database which I&rsquo;ve randomly populated with 1,000,000 rows, to see how long it takes.  Note, I&rsquo;ve cut out the actual results as they are unimportant:</p>

<pre>
mysql> SELECT * FROM conversations WHERE user_id = 41;
12 rows in set (1.42 sec)

mysql> EXPLAIN SELECT * FROM conversations WHERE user_id = 41;
+-------------+------+---------------+---------+-------+---------+-------------+
| select_type | type | key           | key_len | ref   | rows    | Extra       |
+-------------+------+---------------+---------+-------+---------+-------------+
| SIMPLE      | ALL  | NULL          | NULL    | NULL  | 1001111 | Using where |
+-------------+------+---------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)
</pre>


<p>Although the query is simple, it took 1.42 seconds.  The <code>key</code> column show the key or index that MySQL decided to use, in this case <code>NULL</code> as there are no indexes.  The <code>rows</code> column is also relevant.  It shows that MySQL will need to look at around 1,000,000 rows; that&rsquo;s a lot of data being loaded and compared.</p>

<h3>What a difference just an index makes</h3>

<p>If we then add an index on <code>user_id</code>:</p>

<div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:conversations</span><span class="p">,</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;user_id_ix&#39;</span>
</pre>
</div>


<p>And do the same select:</p>

<pre>
mysql> SELECT * FROM conversations WHERE user_id = 41;
12 rows in set (0.01 sec)

mysql> EXPLAIN SELECT * FROM conversations WHERE user_id = 41;
+-------------+------+---------------+---------+-------+---------+-------------+
| select_type | type | key           | key_len | ref   | rows    | Extra       |
+-------------+------+---------------+---------+-------+---------+-------------+
| SIMPLE      | ref  | used_id_ix    | 5       | const |  108    | Using where |
+-------------+------+---------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)
</pre>


<p>The difference is remarkable.  From over 1.4 seconds to about 1 hundredth.  Unless you have a cast-iron reason not to, index your foreign keys.</p>

<h3>Indexing polymorphic associations</h3>

<p>So for simple associations, we can add an index on the foreign_key column.  For polymorphic associations the foreign key is made up of two columns, one for the <code>id</code> and one for the <code>type</code>.  Let&rsquo;s add another association to our models to illustrate this.</p>

<div class="highlight"><pre><span class="n">add_column</span> <span class="ss">:conversations</span><span class="p">,</span> <span class="ss">:subject_id</span><span class="p">,</span> <span class="ss">:integer</span>
<span class="n">add_column</span> <span class="ss">:conversations</span><span class="p">,</span> <span class="ss">:subject_type</span><span class="p">,</span> <span class="ss">:string</span>

<span class="n">create_table</span> <span class="ss">:artworks</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
  <span class="n">table</span><span class="o">.</span><span class="n">string</span> <span class="ss">:title</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Artwork</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_one</span> <span class="ss">:conversation</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:subject</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Conversation</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:subject</span><span class="p">,</span> <span class="ss">:polymorphic</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre>
</div>


<p>Here we&rsquo;ve added an association between Artwork and Conversation, where an artwork can be the subject of a conversation.  From an artwork, we can find the related conversation (if any) with <code>artwork.conversation</code> which will use the following SQL:</p>

<div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">conversations</span> <span class="k">WHERE</span> <span class="n">subject_id</span> <span class="o">=</span> <span class="mi">196</span> <span class="k">and</span> <span class="n">subject_type</span> <span class="o">=</span> <span class="s1">&#39;Artwork&#39;</span><span class="p">;</span>
</pre>
</div>


<p>Again the query takes around 1.4 seconds without any indexes.  Now though, we have a choice on what to index.  We can index either <code>subject_type</code> on its own, <code>subject_id</code> on its own, or both together.</p>

<p>Let&rsquo;s try each in turn, and measure the performance.</p>

<p>First, an index on just <code>subject_type</code>:</p>

<pre>
mysql> SELECT * FROM conversations WHERE subject_id = 196 and subject_type = 'Artwork';
12 rows in set (0.31 sec)

mysql> EXPLAIN SELECT * FROM conversations WHERE subject_id = 196 and subject_type = 'Artwork'
+-------------+------+---------------+---------+-------+---------+-------------+
| select_type | type | key           | key_len | ref   | rows    | Extra       |
+-------------+------+---------------+---------+-------+---------+-------------+
| SIMPLE      | ref  | sub_type_ix   | 5       | const | 89511   | Using where |
+-------------+------+---------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)
</pre>


<p>An index on just <code>subject_id</code>:</p>

<pre>
mysql> SELECT * FROM conversations WHERE subject_id = 196 and subject_type = 'Artwork';
12 rows in set (0.01 sec)

mysql> EXPLAIN SELECT * FROM conversations WHERE subject_id = 196 and subject_type = 'Artwork'
+-------------+------+---------------+---------+-------+---------+-------------+
| select_type | type | key           | key_len | ref   | rows    | Extra       |
+-------------+------+---------------+---------+-------+---------+-------------+
| SIMPLE      | ref  | sub_id_ix     | 5       | const | 204     | Using where |
+-------------+------+---------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)
</pre>


<p>An index on <code>subject_id, subject_type</code>:</p>

<pre>
mysql> SELECT * FROM conversations WHERE subject_id = 196 and subject_type = 'Artwork';
12 rows in set (0.01 sec)

mysql> EXPLAIN SELECT * FROM conversations WHERE subject_id = 196 and subject_type = 'Artwork'
+-------------+------+--------------------+---------+-------+---------+-------------+
| select_type | type | key                | key_len | ref   | rows    | Extra       |
+-------------+------+--------------------+---------+-------+---------+-------------+
| SIMPLE      | ref  | sub_id_and_type_ix | 5       | const | 5       | Using where |
+-------------+------+--------------------+---------+-------+---------+-------------+
1 row in set (0.00 sec)
</pre>


<p>So <code>subject_type</code> compared ~90,000 rows in 0.31 seconds, <code>subject_id</code> compared ~200 rows in 0.01 seconds and <code>subject_id, subject_type</code> compared 4 rows also in 0.01 seconds.  We should add an index to <code>subject_id, subject_type</code> as so:</p>

<div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:conversations</span><span class="p">,</span> <span class="o">[</span><span class="ss">:subject_id</span><span class="p">,</span> <span class="ss">:subject_type</span><span class="o">]</span>
</pre>
</div>


<h3>Wrapping up</h3>

<p>This should give a basic overview of indexes and the performance improvements they can give.  Hopefully I&rsquo;ve shown that <strong>foreign_keys should always be indexed</strong>, and how to index them.  The next article (which I hope to publish later this week) will explain more about how to reason about indexes, and how to identify additional indexes (beyond those on foreign keys) to add.</p>

  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2009/08">11th August 2009</a></span>
    <ul>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
      <li><a href="/tags/databases" rel="tag">databases</a></li>
      <li><a href="/tags/indexes" rel="tag">indexes</a></li>
      <li><a href="/tags/sql" rel="tag">sql</a></li>
      <li><a href="/tags/using-indexes-in-rails" rel="tag">using-indexes-in-rails</a></li>
    </ul>
  </footer>
</article>
<article>
  <header>
    <h1><a href="/2009/06/pimp-my-script-console">Pimp my script/console</a></h1>
  </header>
  <div class="content">
    <p>For a long time I&rsquo;ve had <a href="http://github.com/tomafro/dotfiles/blob/master/dotfiles/irbrc">an .irbrc file</a> and a <a href="http://github.com/tomafro/dotfiles/blob/master/dotfiles/railsrc">.railsrc file</a>, setting up some simple helpers methods in my <code>irb</code> and <code>script/console</code> sessions.  Today though, I wanted to add some more helpers specific to the project I&rsquo;m working on.  Specifically, I wanted to be able to use my <a href="http://github.com/notahat/machinist/tree/master">machinist</a> blueprints, to help me play around with some models.</p>

<p>Adding <a href="http://github.com/notahat/machinist/tree/master">machinist</a> isn&rsquo;t as simple as just requiring my blueprints though &mdash; they require my ActiveRecord models, which aren&rsquo;t available when <code>.irbrc</code> is loaded.  Luckily the solution is simple &mdash; just add a couple of lines to the configuration in environment.rb:</p>

<div class="highlight"><pre><span class="no">Rails</span><span class="o">::</span><span class="no">Initializer</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">IRB</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">gem</span> <span class="s1">&#39;faker&#39;</span>
    <span class="n">config</span><span class="o">.</span><span class="n">gem</span> <span class="s1">&#39;notahat-machinist&#39;</span><span class="p">,</span> <span class="ss">:lib</span> <span class="o">=&gt;</span> <span class="s1">&#39;machinist&#39;</span><span class="p">,</span> <span class="ss">:source</span> <span class="o">=&gt;</span> <span class="s2">&quot;http://gems.github.com&quot;</span>
    <span class="no">IRB</span><span class="o">.</span><span class="n">conf</span><span class="o">[</span><span class="ss">:IRB_RC</span><span class="o">]</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">RAILS_ROOT</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;console&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>The key part is the line starting <code>IRB.conf[:IRB_RC]</code>, which tells <code>irb</code> to run the given when the session starts.  Luckily, this happens after rails has finished initializing.  I&rsquo;ve set it to require <code>config/console.rb</code>, to which I can add all sorts of configuration and helpers, knowing it will only get loaded in <code>script/console</code> sessions where I want these shortcuts, not in my general code.  Here it is:</p>

<div class="highlight"><pre><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/../spec/blueprints.rb&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">tomafro</span>
  <span class="no">Account</span><span class="o">.</span><span class="n">find_by_login</span><span class="p">(</span><span class="s2">&quot;tomafro&quot;</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">bbi</span>
  <span class="no">Client</span><span class="o">.</span><span class="n">find_by_name</span><span class="p">(</span><span class="s2">&quot;Big Bad Industries&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre>
</div>


  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2009/06">22nd June 2009</a></span>
    <ul>
      <li><a href="/tags/ruby" rel="tag">ruby</a></li>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
      <li><a href="/tags/irb" rel="tag">irb</a></li>
      <li><a href="/tags/tip" rel="tag">tip</a></li>
    </ul>
  </footer>
</article>
<article>
  <header>
    <h1><a href="/2009/05/read-active-record-columns-directly-from-the-class">Read ActiveRecord columns directly from the class</a></h1>
  </header>
  <div class="content">
    <p>Sometimes you want to read just a single column from a collection of records, without the overhead of instantiating each and every one.  You could just execute raw SQL, but it&rsquo;s a shame to do away with the nice type conversion <code>ActiveRecord</code> provides.  It&rsquo;d also be a pity to get rid of find scoping, amongst other goodness.</p>

<p>Enter <code>Tomafro::ColumnReader</code>:</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">Tomafro::ColumnReader</span>
  <span class="k">def</span> <span class="nf">column_reader</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="nb">name</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:as</span><span class="p">)</span> <span class="o">||</span> <span class="n">column_name</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">pluralize</span>
    <span class="n">column</span> <span class="o">=</span> <span class="n">columns_hash</span><span class="o">[</span><span class="n">column_name</span><span class="o">.</span><span class="n">to_s</span><span class="o">]</span>
    
    <span class="nb">self</span><span class="o">.</span><span class="n">module_eval</span> <span class="sx">%{</span>
<span class="sx">      def self.</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">(options = {})</span>
<span class="sx">        merged = options.merge(:select =&gt; &#39;</span><span class="si">#{</span><span class="n">column_name</span><span class="si">}</span><span class="sx">&#39;)</span>
<span class="sx">        connection.select_all(construct_finder_sql(merged)).collect do |value| </span>
<span class="sx">          v = value.values.first</span>
<span class="sx">          </span><span class="si">#{</span><span class="n">column</span><span class="o">.</span><span class="n">type_cast_code</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)</span><span class="si">}</span><span class="sx"></span>
<span class="sx">        end</span>
<span class="sx">      end</span>
<span class="sx">    }</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>Once you&rsquo;ve extended <code>ActiveRecord::Base</code> with it, usage is simple.  In your models, declare which columns you want access to:</p>

<div class="highlight"><pre><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">extend</span> <span class="no">Tomafro</span><span class="o">::</span><span class="no">ColumnReader</span>
 
<span class="k">class</span> <span class="nc">Animal</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">column_reader</span> <span class="s1">&#39;id&#39;</span>
  <span class="n">column_reader</span> <span class="s1">&#39;name&#39;</span>  
 
  <span class="n">named_scope</span> <span class="ss">:dangerous</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:carnivorous</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">}</span> 
<span class="k">end</span>
</pre>
</div>


<p>Once you&rsquo;ve done this, you can access values directly from the class, respecting scope, limits and other finder options.</p>

<div class="highlight"><pre><span class="no">Animal</span><span class="o">.</span><span class="n">names</span> 
<span class="c1">#=&gt; [&#39;Lion&#39;, &#39;Tiger&#39;, &#39;Zebra&#39;, &#39;Gazelle&#39;]</span>
 
<span class="no">Animal</span><span class="o">.</span><span class="n">names</span> <span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">1</span> 
<span class="c1">#=&gt; [&#39;Lion&#39;] (Normal finder options supported)</span>
 
<span class="no">Animal</span><span class="o">.</span><span class="n">dangerous</span><span class="o">.</span><span class="n">names</span> 
<span class="c1">#=&gt; [&#39;Lion&#39;, &#39;Tiger&#39;] (Scoping respected)</span>
 
<span class="no">Animal</span><span class="o">.</span><span class="n">ids</span>
<span class="c1">#=&gt; [1, 2, 3] (Values cast correctly)</span>
</pre>
</div>


  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2009/05">29th May 2009</a></span>
    <ul>
      <li><a href="/tags/ruby" rel="tag">ruby</a></li>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
      <li><a href="/tags/active-record" rel="tag">active-record</a></li>
      <li><a href="/tags/column-reader" rel="tag">column-reader</a></li>
    </ul>
  </footer>
</article>
<article>
  <header>
    <h1><a href="/2009/05/automatching-rails-paths-in-cucumber">Automatching rails paths in cucumber</a></h1>
  </header>
  <div class="content">
    <p>If you&rsquo;re using <a href="http://cukes.info/">cucumber</a> as part of your testing, you probably have a <code>paths.rb</code> file that looks something like this:</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">NavigationHelpers</span>
  <span class="k">def</span> <span class="nf">path_to</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">page_name</span>
    
    <span class="k">when</span> <span class="sr">/the home page/</span>
      <span class="n">root_path</span>
    <span class="k">when</span> <span class="sr">/the new client page/</span>
      <span class="n">new_client_path</span>
    <span class="k">when</span> <span class="sr">/the clients page/</span>
      <span class="n">clients_path</span>    
    <span class="c1"># Add more page name =&gt; path mappings here</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="s2">&quot;Can&#39;t find mapping from </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">page_name</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to a path.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;Now, go and add a mapping in features/support/paths.rb&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">World</span><span class="p">(</span><span class="no">NavigationHelpers</span><span class="p">)</span>
</pre>
</div>


<p>This let&rsquo;s us use nice descriptive names in our scenarios, but it starts to become a pain when we add more and more paths.  So how can we make it better?</p>

<p>By automatically matching some rails paths.  Here&rsquo;s the code:</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">NavigationHelpers</span>
  <span class="k">def</span> <span class="nf">path_to</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">page_name</span>
    
    <span class="k">when</span> <span class="sr">/the home page/</span>
      <span class="n">root_path</span>   
    <span class="c1"># Add more page name =&gt; path mappings here</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="n">path</span> <span class="o">=</span> <span class="n">match_rails_path_for</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span> 
        <span class="n">path</span>
      <span class="k">else</span> 
        <span class="k">raise</span> <span class="s2">&quot;Can&#39;t find mapping from </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">page_name</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to a path.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;Now, go and add a mapping in features/support/paths.rb&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">match_rails_path_for</span><span class="p">(</span><span class="n">page_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">page_name</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/the (.*) page/</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">send</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vg">$1</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">_path&quot;</span> <span class="k">rescue</span> <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">World</span><span class="p">(</span><span class="no">NavigationHelpers</span><span class="p">)</span>
</pre>
</div>


<p>What it does is pretty simple.  Given a page name <code>the clients page</code> (with no other matches defined) it will try and send <code>clients_path</code>.  If successful, then it returns the result, otherwise nil.</p>

<p>Not the biggest improvement in the world, but it&rsquo;s made my cucumber tests just a little bit easier to write.</p>

  </div>
  <footer>
    <span class='author'><a rel='author' href='http://tomafro.net'>Tom Ward</a></span>
    <span class='date'><a href="/2009/05">13th May 2009</a></span>
    <ul>
      <li><a href="/tags/cucumber" rel="tag">cucumber</a></li>
      <li><a href="/tags/rails" rel="tag">rails</a></li>
      <li><a href="/tags/ruby" rel="tag">ruby</a></li>
      <li><a href="/tags/testing" rel="tag">testing</a></li>
      <li><a href="/tags/tip" rel="tag">tip</a></li>
    </ul>
  </footer>
</article>

</body>
</html>